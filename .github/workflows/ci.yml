name: Secure Docker CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

env:
  IMAGE_NAME: secure-docker-ci-pipeline-api
  PYTHON_VERSION: '3.11'

jobs:
  lint-dockerfile:
    name: Lint Dockerfile
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          failure-threshold: warning

  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: lint-dockerfile

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: ${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test image runs successfully
        run: |
          docker run -d --name test-container -p 8000:8000 ${{ env.IMAGE_NAME }}:latest
          sleep 5
          docker ps | grep test-container
          docker logs test-container

      - name: Run API health check
        run: |
          curl -f http://localhost:8000/health || exit 1
          curl -f http://localhost:8000/ || exit 1

      - name: Stop test container
        if: always()
        run: docker stop test-container && docker rm test-container

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image for scanning
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: ${{ env.IMAGE_NAME }}:latest

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_NAME }}:latest
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          scanners: 'vuln,config,secret'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run Trivy with table output
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_NAME }}:latest
          format: 'table'
          severity: 'CRITICAL,HIGH'
          scanners: 'vuln,config,secret'
          exit-code: '0'

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: security-scan

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start services with Docker Compose
        run: docker compose up -d

      - name: Wait for API to be ready
        run: |
          timeout 30 sh -c 'until curl -f http://localhost:8000/health; do sleep 2; done'

      - name: Run integration tests
        run: |
          # Test root endpoint
          curl -f http://localhost:8000/ | jq .

          # Test health endpoint
          curl -f http://localhost:8000/health | jq .

          # Create an item
          ITEM_RESPONSE=$(curl -f -X POST http://localhost:8000/items \
            -H "Content-Type: application/json" \
            -d '{"name":"Test Item","price":99.99}')
          echo "$ITEM_RESPONSE" | jq .

          # List items
          curl -f http://localhost:8000/items | jq .

          # Get specific item
          curl -f http://localhost:8000/items/1 | jq .

          # Update item
          curl -f -X PUT http://localhost:8000/items/1 \
            -H "Content-Type: application/json" \
            -d '{"name":"Updated Item","price":149.99}' | jq .

          # Delete item
          curl -f -X DELETE http://localhost:8000/items/1 | jq .

      - name: Check container health
        run: docker compose ps

      - name: Show logs
        if: always()
        run: docker compose logs

      - name: Stop services
        if: always()
        run: docker compose down

  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [lint-dockerfile, build-and-test, security-scan, integration-test]
    if: always()

    steps:
      - name: Pipeline Status
        run: |
          echo "=========================================="
          echo "  Secure Docker CI Pipeline Summary"
          echo "=========================================="
          echo ""
          echo "‚úì Dockerfile linting: ${{ needs.lint-dockerfile.result }}"
          echo "‚úì Build and test: ${{ needs.build-and-test.result }}"
          echo "‚úì Security scan: ${{ needs.security-scan.result }}"
          echo "‚úì Integration tests: ${{ needs.integration-test.result }}"
          echo ""
          if [ "${{ needs.lint-dockerfile.result }}" == "success" ] && \
             [ "${{ needs.build-and-test.result }}" == "success" ] && \
             [ "${{ needs.security-scan.result }}" == "success" ] && \
             [ "${{ needs.integration-test.result }}" == "success" ]; then
            echo "üéâ All checks passed!"
            exit 0
          else
            echo "‚ùå Some checks failed"
            exit 1
          fi
